{% extends "base.html" %}


{% block titulo %}
    Venda de produtos
{% endblock %}

{% block estilo %}

{% endblock %}

{% block corpo %}
    <div class="container mt-5">
        <br>

        <div id="form">

        </div>
        <br>
        <div id="tabela">

        </div>
        <br>
        <br>
        <br>
    </div>
{% endblock %}

{% block domready %}
    $.get("{% url 'produto:cadastra_produto' %}", function (resposta) {
        $("#form").html(resposta)
    })

    $.get("{% url 'produto:lista_produtos' %}", function (resposta) {
        $("#tabela").html(resposta)
    })

    $("#tabela").on("blur", "input", function() {
        let valor = $(this).val()
        if(valor < 1) {
            $(this).focus()
            return
        }
        let form = $(this).parent()
        let url = form.attr("action")
        let formData = form.serializeArray()
        $.post(url, formData, function(resposta) {
            $("#valor-total").text(resposta.preco_total)
        })
    })

    $("#tabela").on("click", ".remover", function() {
        let form = $(this).parent()
        form.append('<input type="hidden" name="qtd" value="0"> ')
        let tr = form.parent().parent()
        let url = form.attr("action")
        let formData = form.serializeArray()
        $.post(url, formData, function(resposta){
            tr.fadeTo('slow', 0.3, function() {
                $(this).remove()
                $("#valor-total").text(resposta.preco_total)
            })
        })
    })

    $("#form").on("click", ".adicionar", function() {
        let form = $("#form").children()
        let tr = form.parent().parent()
        let url = form.attr("action")
        let formData = form.serializeArray()
        $.post(url, formData, function(resposta){
            $("#valor-total").text(resposta.preco_total)
            $(`
                <tr>
                     <td width="10%" class="text-center align-middle">
                        ${ resposta.categoria.nome }
                     </td>
                     <td width="35%" class="align-middle">
                           ${ resposta.novoProduto.nome }
                     </td>
                     <td width="10%" class="text-right align-middle pr-3">
                        <form class="mx-auto" style="width: auto" action="{% url 'produto:atualiza_produtos' %}" method="POST" novalidate>
                            <input type="hidden" value=${ resposta.novoProduto.id } name="id"/>
                            <input type="text" value=${ resposta.novoProduto.qtd } name="qtd"/>
                        </form>
                     </td>
                     <td width="15%" class="text-right align-middle pr-3">
                        ${ resposta.novoProduto.preco }
                     </td>
                     <td width="15%" class="text-right align-middle pr-3">
                        <form action="{% url 'produto:atualiza_produtos' %}" method="POST" novalidate>
                            <input type="hidden" value=${ resposta.novoProduto.id } name="id" />
                           <button type="button" class="btn btn-sm btn-danger remover" tabindex="-1">Remover</button>
                        </form>
                     </td>
                  </tr>
            `).insertBefore($("#ultimoTr"))
        })
    })

{% endblock %}
